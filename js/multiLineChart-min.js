class multilineChart{constructor(t={}){if(this.selector=t.selector?t.selector:"#multilineChart",this.margin=t.margin?t.margin:{top:40,bottom:30,left:50,right:100},this.fatLineWidth=t.fatLineWidth?t.fatLineWidth:3,this.needsMouseGroup=!t.needsMouseGroup||t.needsMouseGroup,this.tickNumber=t.tickNumber?t.tickNumber:4,this.hideLabel=!!t.hideLabel&&t.hideLabel,this.height=t.height?t.height:400-this.margin.top-this.margin.bottom,this.annotationSplitter=t.annotationSplitter?t.annotationSplitter:" ",this.hasConfidenceInterval=!!t.hasConfidenceInterval&&t.hasConfidenceInterval,this.xMin=!!t.xMin&&t.xMin,this.yMax=!!t.yMax&&t.yMax,this.straightLine=!!t.straightLine&&t.straightLine,!0===this.hideLabel&&(this.margin.right=this.margin.left),this.data=null,this.file=t.file,this.yTickFormat=t.yTickFormat?t.yTickFormat:"d",this.timeScale=!!t.timeScale&&t.timeScale,this.exponentScale=!!t.exponentScale&&t.exponentScale,this.logScale=!!t.logScale&&t.logScale,this.annotationsDrawn=!1,this.needsFatLine=!1,this.needsAnnotations=!1,this.tooltip=null,this.mouseG=null,this.mouseMoveTimeout=null,this.countries=[],this.selectedColumns=["CorÃ©e du Sud","Etats-Unis","France","Italie","Royaume-Uni","Suisse"],d3.select(this.selector).node()){this.width=parseInt(d3.select(this.selector).style("width"))-this.margin.left-this.margin.right;var e=d3.select(this.selector).append("svg").attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+this.margin.top+this.margin.bottom);this.g=e.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`)}else console.error("Error: element "+this.selector+" not found");this.createScales(),this.fetch()}addData(t){this.data=t;var e=this;t.forEach((function(t){e.timeScale?t.xValue=new Date(t.timestamp):t.xValue=+t.country_day}));var i=e.hasConfidenceInterval?t.columns.length-2:t.columns.length;this.countries=t.columns.slice(1,i).map((function(e){return{id:e,values:t.map((function(t){return{xValue:t.xValue,value:parseFloat(t[e])}}))}})),this.draw()}fetch(){var t=this;d3.csv(this.file).then((function(e){t.data=e,e.forEach((function(e){t.timeScale?e.xValue=new Date(e.timestamp):e.xValue=+e.country_day}));var i=t.hasConfidenceInterval?e.columns.length-2:e.columns.length;t.countries=e.columns.slice(1,i).map((function(t){return{id:t,values:e.map((function(e){return{xValue:e.xValue,value:parseFloat(e[t])}}))}})),t.draw()}))}createScales(){this.timeScale?this.xscale=d3.scaleTime().range([0,this.width]):this.xscale=d3.scaleLinear().range([0,this.width]),this.exponentScale?(console.log("Exponent scale for",this.selector),this.yscale=d3.scalePow(.5).range([this.height,0])):this.logScale?(console.log("Log scale for",this.selector),this.yscale=d3.scaleLog().clamp(!0).domain([.1,d3.max(this.countries,(function(t){return d3.max(t.values,(function(t){return t.value}))}))]).range([this.height,0])):this.yscale=d3.scaleLinear().range([this.height,0]),this.zscale=d3.scaleOrdinal(d3.schemeCategory10),this.timeScale?this.xaxis=d3.axisBottom().scale(this.xscale).ticks(this.tickNumber).tickFormat(this.width>600?d3.timeFormat("%d %b"):d3.timeFormat("%d.%m")):this.xaxis=d3.axisBottom().scale(this.xscale).ticks(),this.logScale?this.yaxis=d3.axisLeft().scale(this.yscale).ticks(3).tickFormat(d3.format(this.yTickFormat)):this.yaxis=d3.axisLeft().scale(this.yscale).tickFormat(d3.format(this.yTickFormat)),console.log(this.yTickFormat),this.g_xaxis=this.g.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")"),this.g_yaxis=this.g.append("g").attr("class","y axis")}addReLimit(){var t=this.xaxis.scale().domain(),e=this;this.g.append("line").style("stroke","#E06D3A").style("stroke-width",3).attr("x1",(function(i){return e.xscale(t[0])})).attr("y1",(function(t){return e.yscale(1)})).attr("x2",(function(i){return e.xscale(t[1])})).attr("y2",(function(t){return e.yscale(1)}))}addConfidenceInterval(){console.log("Show confidence interval");var t=this;this.g.append("path").datum(this.data).attr("fill","#cce5df").attr("stroke","none").attr("d",d3.area().x((function(e){return t.xscale(e.xValue)})).y0((function(e){return t.yscale(e.min_limit)})).y1((function(e){return t.yscale(e.max_limit)})))}draw(){var t,e=this;this.timeScale?this.xscale.domain(d3.extent(this.data,(function(t){return t.xValue}))):this.xscale.domain(d3.extent(this.data,(function(t){return t.xValue}))).nice,this.logScale?this.yscale.domain([1,this.yMax?this.yMax:d3.max(this.countries,(function(t){return d3.max(t.values,(function(t){return t.value}))}))]):this.yscale.domain([e.xMin?0:d3.min(this.countries,(function(t){return d3.min(t.values,(function(t){return t.value}))})),d3.max(this.countries,(function(t){return d3.max(t.values,(function(t){return t.value}))}))]).nice(),this.zscale.domain(this.countries.map((function(t){return t.id}))),this.g_xaxis.transition().call(this.xaxis),this.g_yaxis.transition().call(this.yaxis),this.hasConfidenceInterval&&this.addConfidenceInterval(),t=this.straightLine?d3.line().defined((function(t){return!isNaN(t.value)})).x((function(t){return e.xscale(t.xValue)})).y((function(t){return e.yscale(t.value)})):d3.line().defined((function(t){return!isNaN(t.value)})).curve(d3.curveBasis).x((function(t){return e.xscale(t.xValue)})).y((function(t){return e.yscale(t.value)}));var i=this.g.selectAll(".city").data(this.countries).enter().append("g").attr("class",(function(t){return"country "+t.id}));i.append("path").attr("class","line").attr("d",(function(e){return t(e.values.filter((function(t){return 0!==t.value})))})).style("stroke",(function(t){return e.zscale(t.id)})),this.hideLabel||i.append("text").datum((function(t){for(var e=t.values.length-1;e>=0&&isNaN(t.values[e].value);)e--;return{id:t.id,value:t.values[e]}})).attr("transform",(function(t){return"translate("+e.xscale(t.value.xValue)+","+e.yscale(t.value.value)+")"})).attr("x",3).attr("dy","0.35em").attr("stroke",(function(t){return"Suisse"===t.id?"#b80021":e.zscale(t.id)})).attr("class","country-label").text((function(t){return t.id})),this.needsFatLine&&this.addFatLine(),this.needsAnnotations,this.needsMouseGroup&&(this.mouseG=this.createMouseGroup()),this.arrangeLabels()}annotate(t,e,i=0,a=-100,s="line",n=null){if(this.data||this.annotationsDrawn){var l=d3.annotationLabel,r=[{note:{title:n,label:t,wrapSplitter:this.annotationSplitter},data:{xValue:e.x,value:e.y},className:"show-bg",dx:i,dy:a,connector:{end:"arrow",type:s}}],o=d3.annotation().type(l).accessors({x:t=>this.xscale(t.xValue),y:t=>this.yscale(t.value)}).accessorsInverse({xValue:t=>this.xscale.invert(t.xValue),value:t=>this.yscale.invert(t.value)}).annotations(r);this.g.append("g").attr("class","annotation-group").call(o),this.annotationsDrawn=!0}else this.needsAnnotations=!0}arrangeLabels(){var t=this;this.g.selectAll(".country-label").each((function(){var e=this,i=this.getBoundingClientRect();t.g.selectAll(".country-label").each((function(){if(this!==e){var a=this.getBoundingClientRect();if(!(i.right<a.left||i.left>a.right||i.bottom<a.top||i.top>a.bottom)){e.getAttribute("y"),this.getAttribute("y");var s=a.top-i.top;s<10&&s>0?(e.setAttribute("y",5),this.setAttribute("y",-5)):s>-10&&s<0&&(e.setAttribute("y",-5),this.setAttribute("y",5)),"#chartDayOffset"===t.selector&&"#d62728"===e.getAttribute("stroke")&&e.setAttribute("x",60),"#chartDayOffset"===t.selector&&"#1f77b4"===e.getAttribute("stroke")&&e.setAttribute("y",10),e.setAttribute("class","country-label moved"),this.setAttribute("class","country-label moved")}}}))}))}addFatLine(){if(this.data){var t=this,e=d3.line().defined((function(t){return""!==t.Suisse})).curve(d3.curveBasis).x((function(e){return t.xscale(e.xValue)})).y((function(e){return t.yscale(e.Suisse)})),i=this.g.append("path").attr("d",e(this.data.filter((function(t){return 0!==t.Suisse})))).attr("stroke","#b80021").attr("stroke-width",this.fatLineWidth).attr("stroke-opacity",.8).attr("fill","none"),a=i.node().getTotalLength();i.attr("stroke-dasharray",a+" "+a).attr("stroke-dashoffset",a).transition().duration(3e3).ease(d3.easeCubic).attr("stroke-dashoffset",1)}else this.needsFatLine=!0}showTooltip(t){var e=[],i=!1;this.countries.forEach((function(a){isNaN(a.values[t].value)||(e.push({country:a.id,value:a.values[t].value}),i||(i=a.values[t].xValue))}));var a="";a=this.timeScale?d3.timeFormat("%d %b")(i):"Jour "+d3.format(this.xTickFormat)(i),e.sort((function(t,e){return d3.descending(t.value,e.value)}));var s=this.xscale(i)+this.margin.left+10;s+200>this.margin.left+this.width&&(console.log(">"),s=this.margin.left+this.width-200),this.tooltip.html("<b>"+a+"</b>").style("display","block").style("opacity",1).style("left",(function(t){return s+"px"})).selectAll().data(e).enter().append("div").html(t=>t.country+": "+t.value.toLocaleString())}createMouseGroup(){if(!this.countries||!this.zscale)return console.warn("Mouse group: data not ready yet"),!1;var t=this;this.tooltip=d3.select(this.selector).append("div").attr("class","tooltip").style("padding",6).style("left","200px").style("top","20px").html("").style("display","none");var e=this.g.append("g").attr("class","mouse-over-effects");e.append("path").attr("class","mouse-line").style("stroke","#A9A9A9").style("stroke-width","0.5pt").style("opacity",0);document.getElementsByClassName("line");return e.selectAll(".mouse-per-line").data(this.countries).enter().append("g").attr("class","mouse-per-line").append("circle").attr("r",4).style("stroke",(function(t){return"#ccc"})).style("fill","none").style("stroke-width","1px").style("opacity",0),e.append("svg:rect").attr("width",this.width).attr("height",this.height).attr("fill","none").attr("pointer-events","all").on("mouseout",(function(){clearTimeout(t.mouseMoveTimeout),e.select(".mouse-line").style("opacity","0"),e.selectAll(".mouse-per-line circle").style("opacity","0"),e.selectAll(".mouse-per-line text").style("opacity","0"),t.tooltip.style("display","none")})).on("mouseover",(function(){e.select(".mouse-line").style("opacity","1"),e.selectAll(".mouse-per-line circle").style("opacity","1"),t.tooltip.style("display","block")})).on("mousemove",(function(){clearTimeout(t.mouseMoveTimeout);var i=d3.mouse(this);t.mouseMoveTimeout=setTimeout((function(){var a=t.xscale.invert(i[0]),s=d3.bisector((function(t){return t.xValue})).left,n=-1;e.selectAll(".mouse-per-line").attr("transform",(function(i,l){return-1===n&&(n=s(i.values,a)),void 0!==i.values[n]?isNaN(i.values[n].value)?"":(e.select(".mouse-line").attr("d",(function(){var e="M"+t.xscale(i.values[n].xValue)+","+t.height;return e+=" "+t.xscale(i.values[n].xValue)+",0"})),"translate("+t.xscale(i.values[n].xValue)+","+t.yscale(i.values[n].value)+")"):""})),t.showTooltip(n)}),5)})),e}}